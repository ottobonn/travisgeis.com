<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8a856ac569de13b8b669.css" data-identity="gatsby-global-css">@font-face{font-family:Travis Print One;src:url(/static/TravisPrintOne-Regular-395b4112e8d8e4c008f2f27beb638a30.woff2) format("woff2")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#d4d0ab}.token.punctuation{color:#fefefe}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#ffa07a}.token.boolean,.token.number{color:#00e0e0}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#abe338}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#00e0e0}.token.atrule,.token.attr-value,.token.function{color:gold}.token.keyword{color:#00e0e0}.token.important,.token.regex{color:gold}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media screen and (-ms-high-contrast:active){code[class*=language-],pre[class*=language-]{background:window;color:windowText}:not(pre)>code[class*=language-],pre[class*=language-]{background:window}.token.important{background:highlight;color:window;font-weight:400}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:700}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight}.token.attr-value,.token.url{font-weight:400}}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}:root{--accent-color:#6a39ff;--code-font:"Anonymous Pro";--code-padding:2em;--code-size:75%;--font-name:"Spectral";--font-size:24px;--header-font:"Rubik",sans-serif;--link-underline:underline;--neutral-background-color:#f9f9f9;--title-box-offset:0.5rem;--title-top-margin:1rem;--link-color:var(--accent-color);--boxy-color:var(--accent-color);--wide-width:100%;--wide-margin-left:0}body{font-family:var(--font-name);font-size:var(--font-size)}h1,h2,h3,h4,h5,h6{font-family:var(--header-font);line-height:1.28571429em;margin:calc(2rem - .14286em) 0 1rem}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:-.14285714em}h1:last-child,h2:last-child,h3:last-child,h4:last-child,h5:last-child,h6:last-child{margin-bottom:0}.boxy,.gatsby-resp-image-wrapper,p>img{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color)}.gatsby-resp-image-wrapper,p>img{margin-left:var(--wide-margin-left)!important;width:var(--wide-width)}.video-container{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);height:0;margin-bottom:2rem;margin-top:2rem;padding-bottom:56.25%;position:relative;width:100%}.video-container iframe{height:100%;left:0;position:absolute;top:0;width:100%}stl-viewer{display:block;height:500px;width:100%}code{font-family:var(--code-font)!important}:not(pre)>code{background-color:#eee!important;border-radius:0!important;color:#000!important;padding:.2em!important}.gatsby-highlight{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);margin:.5em 0;margin-left:var(--wide-margin-left);overflow:auto;width:var(--wide-width)}.gatsby-highlight pre[class*=language-]{border-radius:0;margin:0;overflow:hidden;padding:var(--code-padding)}.gatsby-highlight pre[class*=language-] code{display:block;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{font-size:var(--code-size);padding-left:3em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none;left:1em!important;opacity:.5;top:var(--code-padding)}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Connecting to Gauges with Bluetooth</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Spectral|Rubik|Anonymous+Pro" rel="stylesheet"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128"/><meta data-react-helmet="true" name="application-name" content="travisgeis.com"/><meta data-react-helmet="true" name="msapplication-TileColor" content="#FFFFFF"/><meta data-react-helmet="true" name="msapplication-TileImage" content="/favicons/mstile-144x144.png"/><meta data-react-helmet="true" name="msapplication-square70x70logo" content="/favicons/mstile-70x70.png"/><meta data-react-helmet="true" name="msapplication-square150x150logo" content="/favicons/mstile-150x150.png"/><meta data-react-helmet="true" name="msapplication-wide310x150logo" content="/favicons/mstile-310x150.png"/><meta data-react-helmet="true" name="msapplication-square310x310logo" content="/favicons/mstile-310x310.png"/><script data-react-helmet="true" type="module" src="/stl-viewer/stl-viewer.js"></script><style data-styled="" data-styled-version="5.3.0">.cnoNVM{max-width:1024px;margin-left:auto;margin-right:auto;}/*!sc*/
data-styled.g4[id="Layout__Container-sc-1arw8t8-0"]{content:"cnoNVM,"}/*!sc*/
.goernf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g5[id="Menu__MenuContainer-zgpfzl-0"]{content:"goernf,"}/*!sc*/
.hRhFsN{-webkit-text-decoration:none;text-decoration:none;font-family:var(--header-font);-webkit-flex:1;-ms-flex:1;flex:1;text-align:center;padding:0.5em;border-radius:0.25em;color:inherit;}/*!sc*/
.hRhFsN:hover{background-color:#eee;}/*!sc*/
data-styled.g6[id="Menu__MenuLink-zgpfzl-1"]{content:"hRhFsN,"}/*!sc*/
.jmvzGK{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1rem;margin-top:var(--title-top-margin);margin-bottom:2rem;}/*!sc*/
.jmvzGK a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g7[id="Titles__TitleDiv-sc-5xl7gs-0"]{content:"jmvzGK,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-d8157e8dded65c3ff337.js"/><link as="script" rel="preload" href="/framework-065c3db88fdd2b546387.js"/><link as="script" rel="preload" href="/app-8b28952f62241afbe9f6.js"/><link as="script" rel="preload" href="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"/><link as="fetch" rel="preload" href="/page-data/2012/03/20/connecting-to-gauges-with-bluetooth/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout__Container-sc-1arw8t8-0 cnoNVM"><div class="page"><div id="content"><div id="menu" class="Menu__MenuContainer-zgpfzl-0 goernf menu"><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/"><i class="icon home"></i>travisgeis.com</a><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/contact"><i class="icon comments"></i>Contact</a></div><div id="titles" class="Titles__TitleDiv-sc-5xl7gs-0 jmvzGK"><h1>Connecting to Gauges with Bluetooth</h1><h3>20 March 2012</h3></div><i>About a <!-- -->1<!-- -->-minute read</i><p>Over the past few days I’ve worked on connecting Gauges to my computer over
Bluetooth. I have the physical gauges attached to an Arduino and a breadboard,
and I am using a
<a href="http://www.sparkfun.com/products/10269" title="BlueSmirf Silver product page">Sparkfun BlueSmirf Silver</a>
to receive streaming data from my laptop.</p><p>I wrote a Python script using the
<a href="http://code.google.com/p/pybluez/" title="PyBlueZ at Google Code">PyBlueZ</a>
stack to connect to the Bluesmirf. I had tried using
<a href="http://pyserial.sourceforge.net/" title="PySerial on SourceForge">PySerial</a>,
a great package, to write directly to the symbolic /dev/rfcomm0 representing
serial bluetooth devices in Linux, but
<a href="http://askubuntu.com/questions/114171/why-is-dev-rfcomm0-giving-pyserial-problems" title="My question on Ask Ubuntu">the connection had problems</a>.
The problems I thought I could avoid by switching to PyBlueZ popped up again,
and I am still hunting for a solution.</p><p>When I start the Python script, which I call “gauges-daemon” since eventually it
will run as a Linux daemon, or background task, the connection opens fine and
the gauges respond. However, after a certain period of activity the script
suddenly encounters BluetoothError #11, “Resource Temporaily Unavailable.” To
counter this error I thought I could have the script re-open the connection, but
then I get error #16, “Device or Resource Busy”.</p><p>I did some permuting and found that I can start the script, wait for it to fail,
and then re-start the BlueSmirf. This allows the script to reconnect. The
evidence seems to suggest that the problem is with the BlueSmirf, though I have
pored over
<a href="http://www.sparkfun.com/datasheets/Wireless/Bluetooth/rn-bluetooth-um.pdf" title="The RN-42 radio manual">the datasheet (PDF)</a>
and found no mention about necessary steps to keep
connections alive.</p><p><strong>EDIT: The problem was a buffer overflow on the PC.</strong> I was sending Bluetooth
messages to the Gauges, which would respond with status text. Because the
Python script never read the port for incoming messages, these incoming
packets collected in the Bluetooth serial buffer and everything halted until
the buffer was cleared.</p><p>I fixed the Python script to represent the necessary changes:</p><div class="gatsby-highlight" data-language="python"><pre style="counter-reset:linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> psutil
<span class="token keyword">import</span> serial
<span class="token keyword">import</span> string
<span class="token keyword">import</span> time
<span class="token keyword">import</span> bluetooth

sampleTime <span class="token operator">=</span> <span class="token number">1</span>
numSamples <span class="token operator">=</span> <span class="token number">5</span>
lastTemp <span class="token operator">=</span> <span class="token number">0</span>

TEMP_CHAR <span class="token operator">=</span> <span class="token string">&#x27;t&#x27;</span>
USAGE_CHAR <span class="token operator">=</span> <span class="token string">&#x27;u&#x27;</span>
SENSOR_NAME <span class="token operator">=</span> <span class="token string">&#x27;TC0D&#x27;</span>

filename <span class="token operator">=</span> <span class="token string">&#x27;/sys/bus/platform/devices/applesmc.768/temp2_input&#x27;</span>

<span class="token keyword">def</span> <span class="token function">parseSensorsOutputLinux</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">try</span><span class="token punctuation">:</span>
			gaugeSocket <span class="token operator">=</span> bluetooth<span class="token punctuation">.</span>BluetoothSocket<span class="token punctuation">(</span>bluetooth<span class="token punctuation">.</span>RFCOMM<span class="token punctuation">)</span>
			gaugeSocket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&#x27;00:06:66:42:22:96&#x27;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">except</span> bluetooth<span class="token punctuation">.</span>btcommon<span class="token punctuation">.</span>BluetoothError <span class="token keyword">as</span> error<span class="token punctuation">:</span>
			gaugeSocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">print</span> <span class="token string">&quot;Could not connect: &quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> <span class="token string">&quot;; Retrying in 10s...&quot;</span>
			time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> gaugeSocket<span class="token punctuation">;</span>

gaugeSocket <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	usage <span class="token operator">=</span> psutil<span class="token punctuation">.</span>cpu_percent<span class="token punctuation">(</span>interval<span class="token operator">=</span>sampleTime<span class="token punctuation">)</span>
	sensorFile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
	temp <span class="token operator">=</span> parseSensorsOutputLinux<span class="token punctuation">(</span>sensorFile<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		gaugeSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>USAGE_CHAR<span class="token punctuation">)</span>
		gaugeSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>usage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">#print(&quot;Wrote usage: &quot; + str(int(usage)))</span>

		gaugeSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>TEMP_CHAR<span class="token punctuation">)</span>
		gaugeSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span> gaugeSocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
		<span class="token comment">#print(&quot;Wrote temp: &quot; + str(temp))</span>
	<span class="token keyword">except</span> bluetooth<span class="token punctuation">.</span>btcommon<span class="token punctuation">.</span>BluetoothError <span class="token keyword">as</span> error<span class="token punctuation">:</span>
		<span class="token keyword">print</span> <span class="token string">&quot;Caught BluetoothError: &quot;</span><span class="token punctuation">,</span> error
		time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
		gaugeSocket <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">pass</span>

gaugeSocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h2>Comments</h2><div id="cusdis_thread" data-host="https://travisgeis-cusdis.vercel.app" data-page-id="2012/03/20/connecting-to-gauges-with-bluetooth/" data-app-id="bfc86e4c-f4e1-4135-8790-cf52804a5850" data-page-title="Connecting to Gauges with Bluetooth" data-page-url="https://travisgeis.com/2012/03/20/connecting-to-gauges-with-bluetooth"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2012/03/20/connecting-to-gauges-with-bluetooth/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8b28952f62241afbe9f6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-933a06e9dadf888491cb.js"],"component---src-pages-page-slug-tsx":["/component---src-pages-page-slug-tsx-6a9c919aefa8eb61bff6.js"],"component---src-pages-post-slug-tsx":["/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"],"component---src-pages-project-slug-tsx":["/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-be59b2f1846831e4e707.js"]};/*]]>*/</script><script src="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js" async=""></script><script src="/app-8b28952f62241afbe9f6.js" async=""></script><script src="/framework-065c3db88fdd2b546387.js" async=""></script><script src="/webpack-runtime-d8157e8dded65c3ff337.js" async=""></script></body></html>