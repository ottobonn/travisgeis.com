<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8a856ac569de13b8b669.css" data-identity="gatsby-global-css">@font-face{font-family:Travis Print One;src:url(/static/TravisPrintOne-Regular-395b4112e8d8e4c008f2f27beb638a30.woff2) format("woff2")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#d4d0ab}.token.punctuation{color:#fefefe}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#ffa07a}.token.boolean,.token.number{color:#00e0e0}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#abe338}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#00e0e0}.token.atrule,.token.attr-value,.token.function{color:gold}.token.keyword{color:#00e0e0}.token.important,.token.regex{color:gold}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media screen and (-ms-high-contrast:active){code[class*=language-],pre[class*=language-]{background:window;color:windowText}:not(pre)>code[class*=language-],pre[class*=language-]{background:window}.token.important{background:highlight;color:window;font-weight:400}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:700}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight}.token.attr-value,.token.url{font-weight:400}}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}:root{--accent-color:#6a39ff;--code-font:"Anonymous Pro";--code-padding:2em;--code-size:75%;--font-name:"Spectral";--font-size:24px;--header-font:"Rubik",sans-serif;--link-underline:underline;--neutral-background-color:#f9f9f9;--title-box-offset:0.5rem;--title-top-margin:1rem;--link-color:var(--accent-color);--boxy-color:var(--accent-color);--wide-width:100%;--wide-margin-left:0}body{font-family:var(--font-name);font-size:var(--font-size)}h1,h2,h3,h4,h5,h6{font-family:var(--header-font);line-height:1.28571429em;margin:calc(2rem - .14286em) 0 1rem}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:-.14285714em}h1:last-child,h2:last-child,h3:last-child,h4:last-child,h5:last-child,h6:last-child{margin-bottom:0}.boxy,.gatsby-resp-image-wrapper,p>img{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color)}.gatsby-resp-image-wrapper,p>img{margin-left:var(--wide-margin-left)!important;width:var(--wide-width)}.video-container{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);height:0;margin-bottom:2rem;margin-top:2rem;padding-bottom:56.25%;position:relative;width:100%}.video-container iframe{height:100%;left:0;position:absolute;top:0;width:100%}stl-viewer{display:block;height:500px;width:100%}code{font-family:var(--code-font)!important}:not(pre)>code{background-color:#eee!important;border-radius:0!important;color:#000!important;padding:.2em!important}.gatsby-highlight{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);margin:.5em 0;margin-left:var(--wide-margin-left);overflow:auto;width:var(--wide-width)}.gatsby-highlight pre[class*=language-]{border-radius:0;margin:0;overflow:hidden;padding:var(--code-padding)}.gatsby-highlight pre[class*=language-] code{display:block;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{font-size:var(--code-size);padding-left:3em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none;left:1em!important;opacity:.5;top:var(--code-padding)}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Optimizing image sizes in Hexo</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Spectral|Rubik|Anonymous+Pro" rel="stylesheet"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128"/><meta data-react-helmet="true" name="application-name" content="travisgeis.com"/><meta data-react-helmet="true" name="msapplication-TileColor" content="#FFFFFF"/><meta data-react-helmet="true" name="msapplication-TileImage" content="/favicons/mstile-144x144.png"/><meta data-react-helmet="true" name="msapplication-square70x70logo" content="/favicons/mstile-70x70.png"/><meta data-react-helmet="true" name="msapplication-square150x150logo" content="/favicons/mstile-150x150.png"/><meta data-react-helmet="true" name="msapplication-wide310x150logo" content="/favicons/mstile-310x150.png"/><meta data-react-helmet="true" name="msapplication-square310x310logo" content="/favicons/mstile-310x310.png"/><script data-react-helmet="true" type="module" src="/stl-viewer/stl-viewer.js"></script><style data-styled="" data-styled-version="5.3.0">.cnoNVM{max-width:1024px;margin-left:auto;margin-right:auto;}/*!sc*/
data-styled.g4[id="Layout__Container-sc-1arw8t8-0"]{content:"cnoNVM,"}/*!sc*/
.goernf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g5[id="Menu__MenuContainer-zgpfzl-0"]{content:"goernf,"}/*!sc*/
.hRhFsN{-webkit-text-decoration:none;text-decoration:none;font-family:var(--header-font);-webkit-flex:1;-ms-flex:1;flex:1;text-align:center;padding:0.5em;border-radius:0.25em;color:inherit;}/*!sc*/
.hRhFsN:hover{background-color:#eee;}/*!sc*/
data-styled.g6[id="Menu__MenuLink-zgpfzl-1"]{content:"hRhFsN,"}/*!sc*/
.jmvzGK{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1rem;margin-top:var(--title-top-margin);margin-bottom:2rem;}/*!sc*/
.jmvzGK a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g7[id="Titles__TitleDiv-sc-5xl7gs-0"]{content:"jmvzGK,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-d8157e8dded65c3ff337.js"/><link as="script" rel="preload" href="/framework-065c3db88fdd2b546387.js"/><link as="script" rel="preload" href="/app-8b28952f62241afbe9f6.js"/><link as="script" rel="preload" href="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"/><link as="fetch" rel="preload" href="/page-data/2017/03/03/optimizing-image-sizes-in-hexo/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout__Container-sc-1arw8t8-0 cnoNVM"><div class="page"><div id="content"><div id="menu" class="Menu__MenuContainer-zgpfzl-0 goernf menu"><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/"><i class="icon home"></i>travisgeis.com</a><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/contact"><i class="icon comments"></i>Contact</a></div><div id="titles" class="Titles__TitleDiv-sc-5xl7gs-0 jmvzGK"><h1>Optimizing image sizes in Hexo</h1><h3>3 March 2017</h3></div><i>About a <!-- -->6<!-- -->-minute read</i><p>I use Hexo to generate my site. It’s a static site generator, and it follows the typical paradigm of keeping posts (in Markdown format) in a <code class="language-text">source</code> folder, along with images and other resources. The idea is to keep all the “originals” in the source directory, and then use the site generator to render them to their final display format, into an output directory.</p><p>The problem is that source images are large. I want to keep them in their original full resolutions, because I might want to target bigger displays or allow people to download them, and in general because I want the source directory to be a complete archive of the site’s content.</p><p>Instead of serving these huge images to the user, it would be better to make them as small as possible without degrading the experience of looking at them. How big they need to be depends on what they’re for. If they’re thumbnails in a gallery, for example, they should be really small files! A full-width banner image should obviously be larger. But none of these likely needs to be the original size, which is often on the order of 4 MB.</p><p>Dynamic CMSs like Wordpress already solve this problem, by serving images derived from the ones you upload, resized based on your theme’s settings. For a static site, putting out images with different viewing “profiles” should be just as easy, but I didn’t see a way to do that with Hexo, so I wrote a plugin.</p><h2>hexo-image-sizes</h2><p>The <a href="https://github.com/ottobonn/hexo-image-sizes"><code class="language-text">hexo-image-sizes</code> plugin</a>
lets you define image profiles, which specify the optimal size for the image, and then it takes care of generating the images for you. Each source image is then available for use in the original format and in the format of each of the profiles.</p><p>You can read about how to use it <a href="https://github.com/ottobonn/hexo-image-sizes">on Github</a>. I’m not going to cover that here; instead, I’d like to discuss some of the design decisions involved in making it.</p><h2>How it works</h2><h3>The Hexo API</h3><p><code class="language-text">hexo-image-sizes</code> is a Hexo plugin, which means it uses the <a href="https://hexo.io/api/">Hexo API</a> to interact with your site’s files. Hexo has a pretty flexible API, though the documentation is a little too terse for comfort sometimes.</p><p>The plugin API revolves around these core concepts:</p><ul><li>Plugins are <code class="language-text">npm</code> modules whose names start with <code class="language-text">&quot;hexo-&quot;</code></li><li>Hexo loads plugins automatically at start and provides them with the <code class="language-text">hexo</code> global instance object, which includes your site information</li><li>Text files and (and anything else that registers) are “rendered” through renderer functions which receive the file data and return its rendered form</li><li>Other files, like images, get copied directly to the output directory</li><li>Plugins can register <code class="language-text">processor</code> functions to listen for filenames matching a certain pattern and do things with the filenames</li></ul><h3>Renderer?</h3><p>My first attempt was to make a renderer for the images, to intercept them in the pipeline and resize them. There are two problems here.</p><p>The first problem is that renderers are designed to transform the input file into some other, final format, and they can’t control the name of the output, or how many outputs there should be. So if we want to create multiple different sizes of one source image, a renderer isn’t the way to go.</p><p>The other problem is that we don’t really want to read the image data into Javascript-land. The image files can be huge, and Hexo loads asynchronously and seemingly without any throttling all the files for which renderers have registered, so the memory penalty of loading all images in order to render them is not acceptable.</p><h3>Processor!</h3><p>Instead, we want to keep the image handling as low-level as possible. The awesome <a href="https://github.com/lovell/sharp"><code class="language-text">sharp</code></a> module uses a native-compiled <a href="http://www.vips.ecs.soton.ac.uk/index.php?title=VIPS"><code class="language-text">libvips</code></a> under the hood to handle images, so the memory overhead should be much lower if we can just pass <code class="language-text">sharp</code> the name of an input file and the path to which to write the resized image.</p><p>The “processor” abstraction in Hexo gives us visibility into the stream of files Hexo is processing for the site. Each processor is simply a function, and it is invoked with a Hexo <code class="language-text">File</code> object as its only argument. The important keys in this object are the “type” and “source”.</p><ul><li>The file <code class="language-text">type</code> indicates what Hexo is doing with it. It’s one of these strings: <code class="language-text">&quot;create&quot;</code>, <code class="language-text">&quot;update&quot;</code>, <code class="language-text">&quot;skip&quot;</code>, <code class="language-text">&quot;delete&quot;</code> (as seen in <a href="https://github.com/hexojs/hexo/blob/5234c4a85dc6cd418e9a1c169e43de169cf98e95/lib/box/file.js#L33-L36">the source code</a>; this is an example of where the docs are lacking). For now, I only look at files that we’re creating or updating, but in the future I should probably handle deleting files as well.</li><li>The <code class="language-text">source</code> contains the file’s full path on disk.</li></ul><p>Now we simply need to tell <code class="language-text">sharp</code> this file’s <code class="language-text">source</code> and where to
write the output.</p><h3>Wither output?</h3><p>So here’s the ugly hack of using a processor for generating these images: we receive information about the input file, but we have to <em>guess</em> the name of the output file. From what I can tell, Hexo simply uses the <code class="language-text">public_dir</code> configured in <code class="language-text">_config.yml</code> as the base path, and then tacks on the path of the input file relative to the <code class="language-text">source</code> directory. However, that could change, and my plugin wouldn’t work anymore.</p><p>I name the output files based on the original filename and the name of the current profile. So if we have a profile called “thumbnail”, then an image called “cat.jpg” will end up in the output directory at full size as “cat.jpg” and as a thumbnail at “thumbnail-cat.jpg”.</p><p>There’s one more complication, which is that the plugin will run when Hexo starts up. Unfortunately, that means we’re running ahead of the renderers, and it could be that none of the output directory structure exists yet. After deciding on the full output path, we have to make sure that path exists. I’m using <code class="language-text">mkdirp</code> to create a directory with all of its intermediate ancestors if it doesn’t already exist.</p><h3>Using the images</h3><p>So we’ve resized the images, and now the output directory contains a copy of the original and potentially several resized copies with various names. We could just use one of these new filenames in our Markdown posts directly, but that situation is brittle, because changing the names of profiles could cause images not to show up at all.</p><p>While we’re messing with the images, it’s a good time to note that Markdown doesn’t have a mechanism for captioning images, besides repeating some HTML snippet for each one. This too is brittle, and mixes elements of the site’s theme into the source posts, which is not what we want.</p><p>Unfortunately (or maybe fortunately, depending on your bent), Markdown doesn’t have an official means of extension, so I can’t build support for captions and image profiles directly. Hexo allows Nunjucks tags in posts through its <a href="https://hexo.io/api/tag.html">Tag API</a>, which is the next best option. The upside is that we get a lot more options for controlling the output now, but the tradeoff is that we’re no longer writing standard Markdown, and our posts depend on this plugin now. I considered this trade for a few days, and decided this was the best course, but it was a tough call.</p><h3>The <code class="language-text">imsize</code> tag</h3><p>I wanted a tag that is as self-documenting as possible, so if this plugin dies or the posts need to migrate to a different platform, it will be as easy as possible to support these image tags.</p><p>There are two choices for passing data to Nunjucks tags: “args” and “content.” A tag looks like this:</p><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">{% blockquote David Levithan, Wide Awake %}
Do not just seek happiness for yourself. Seek happiness for all.
Through kindness. Through mercy.
{% endblockquote %}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div><ul><li><code class="language-text">args</code> is an array formed from the string passed in the tag line. Here, it is <!-- -->[“David”, “Levithan,”, “Wide”, “Awake”]<!-- -->. Hexo parses the arg line <a href="https://github.com/hexojs/hexo/blob/5234c4a85dc6cd418e9a1c169e43de169cf98e95/lib/extend/tag.js#L86-L113">here</a>.</li><li><code class="language-text">content</code> is the string between the opening and closing tags.</li></ul><p>Given that I want self-documenting tags, I’m not too worried about brevity.
Copy-and-paste is pretty easy, and authors can set up editor shortcuts to insert these tags if needed.</p><p>Passing arguments through the arg line becomes unreadable for more than even a few arguments. The spec for that blockquote tag is:</p><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">{% blockquote [author[, source]] [link] [source_link_title] %}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p>These are all positional arguments, and any of them can be elided! Handing that is not easy, and it doesn’t scale nor is it self-explanatory later.</p><p>Instead, I decided to embed a <a href="http://yaml.org/start.html">YAML</a> document in the tag’s content. YAML is very easy to read, and I don’t have to write a parser for it. By using a YAML document in the tag content, I can add more arguments in the future without breaking existing documents.</p><p>Tags look like this:</p><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">![Dell Precision 5510 repair](../uploads/2017/01/05/5510-repair.jpg)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p>We can specify the <code class="language-text">src</code> and <code class="language-text">profile</code>, and alt text. In the future, we could add a caption, and potentially even an output format (.webp, for example). I’d like to add those possibilities soon.</p><p>Since this is normal YAML, other people can write parsers for this tag for their blogging platforms if needed. It’s a little wordy, but I think it’s very clear.</p><p>There’s more to come on this project, hopefully soon! I’m already using this plugin to generate the images on this site. Head over to the <a href="https://github.com/ottobonn/hexo-image-sizes">Github repo</a> to try it out!</p><h2>Comments</h2><div id="cusdis_thread" data-host="https://travisgeis-cusdis.vercel.app" data-page-id="2017/03/03/optimizing-image-sizes-in-hexo/" data-app-id="bfc86e4c-f4e1-4135-8790-cf52804a5850" data-page-title="Optimizing image sizes in Hexo" data-page-url="https://travisgeis.com/2017/03/03/optimizing-image-sizes-in-hexo"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2017/03/03/optimizing-image-sizes-in-hexo/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8b28952f62241afbe9f6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-933a06e9dadf888491cb.js"],"component---src-pages-page-slug-tsx":["/component---src-pages-page-slug-tsx-6a9c919aefa8eb61bff6.js"],"component---src-pages-post-slug-tsx":["/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"],"component---src-pages-project-slug-tsx":["/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-be59b2f1846831e4e707.js"]};/*]]>*/</script><script src="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js" async=""></script><script src="/app-8b28952f62241afbe9f6.js" async=""></script><script src="/framework-065c3db88fdd2b546387.js" async=""></script><script src="/webpack-runtime-d8157e8dded65c3ff337.js" async=""></script></body></html>