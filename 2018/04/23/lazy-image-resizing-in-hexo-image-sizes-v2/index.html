<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8a856ac569de13b8b669.css" data-identity="gatsby-global-css">@font-face{font-family:Travis Print One;src:url(/static/TravisPrintOne-Regular-395b4112e8d8e4c008f2f27beb638a30.woff2) format("woff2")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#d4d0ab}.token.punctuation{color:#fefefe}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#ffa07a}.token.boolean,.token.number{color:#00e0e0}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#abe338}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#00e0e0}.token.atrule,.token.attr-value,.token.function{color:gold}.token.keyword{color:#00e0e0}.token.important,.token.regex{color:gold}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media screen and (-ms-high-contrast:active){code[class*=language-],pre[class*=language-]{background:window;color:windowText}:not(pre)>code[class*=language-],pre[class*=language-]{background:window}.token.important{background:highlight;color:window;font-weight:400}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:700}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight}.token.attr-value,.token.url{font-weight:400}}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}:root{--accent-color:#6a39ff;--code-font:"Anonymous Pro";--code-padding:2em;--code-size:75%;--font-name:"Spectral";--font-size:24px;--header-font:"Rubik",sans-serif;--link-underline:underline;--neutral-background-color:#f9f9f9;--title-box-offset:0.5rem;--title-top-margin:1rem;--link-color:var(--accent-color);--boxy-color:var(--accent-color);--wide-width:100%;--wide-margin-left:0}body{font-family:var(--font-name);font-size:var(--font-size)}h1,h2,h3,h4,h5,h6{font-family:var(--header-font);line-height:1.28571429em;margin:calc(2rem - .14286em) 0 1rem}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:-.14285714em}h1:last-child,h2:last-child,h3:last-child,h4:last-child,h5:last-child,h6:last-child{margin-bottom:0}.boxy,.gatsby-resp-image-wrapper,p>img{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color)}.gatsby-resp-image-wrapper,p>img{margin-left:var(--wide-margin-left)!important;width:var(--wide-width)}.video-container{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);height:0;margin-bottom:2rem;margin-top:2rem;padding-bottom:56.25%;position:relative;width:100%}.video-container iframe{height:100%;left:0;position:absolute;top:0;width:100%}stl-viewer{display:block;height:500px;width:100%}code{font-family:var(--code-font)!important}:not(pre)>code{background-color:#eee!important;border-radius:0!important;color:#000!important;padding:.2em!important}.gatsby-highlight{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);margin:.5em 0;margin-left:var(--wide-margin-left);overflow:auto;width:var(--wide-width)}.gatsby-highlight pre[class*=language-]{border-radius:0;margin:0;overflow:hidden;padding:var(--code-padding)}.gatsby-highlight pre[class*=language-] code{display:block;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{font-size:var(--code-size);padding-left:3em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none;left:1em!important;opacity:.5;top:var(--code-padding)}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Lazy image resizing in hexo-image-sizes v2</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Spectral|Rubik|Anonymous+Pro" rel="stylesheet"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128"/><meta data-react-helmet="true" name="application-name" content="travisgeis.com"/><meta data-react-helmet="true" name="msapplication-TileColor" content="#FFFFFF"/><meta data-react-helmet="true" name="msapplication-TileImage" content="/favicons/mstile-144x144.png"/><meta data-react-helmet="true" name="msapplication-square70x70logo" content="/favicons/mstile-70x70.png"/><meta data-react-helmet="true" name="msapplication-square150x150logo" content="/favicons/mstile-150x150.png"/><meta data-react-helmet="true" name="msapplication-wide310x150logo" content="/favicons/mstile-310x150.png"/><meta data-react-helmet="true" name="msapplication-square310x310logo" content="/favicons/mstile-310x310.png"/><script data-react-helmet="true" type="module" src="/stl-viewer/stl-viewer.js"></script><style data-styled="" data-styled-version="5.3.0">.cnoNVM{max-width:1024px;margin-left:auto;margin-right:auto;}/*!sc*/
data-styled.g4[id="Layout__Container-sc-1arw8t8-0"]{content:"cnoNVM,"}/*!sc*/
.goernf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g5[id="Menu__MenuContainer-zgpfzl-0"]{content:"goernf,"}/*!sc*/
.hRhFsN{-webkit-text-decoration:none;text-decoration:none;font-family:var(--header-font);-webkit-flex:1;-ms-flex:1;flex:1;text-align:center;padding:0.5em;border-radius:0.25em;color:inherit;}/*!sc*/
.hRhFsN:hover{background-color:#eee;}/*!sc*/
data-styled.g6[id="Menu__MenuLink-zgpfzl-1"]{content:"hRhFsN,"}/*!sc*/
.jmvzGK{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1rem;margin-top:var(--title-top-margin);margin-bottom:2rem;}/*!sc*/
.jmvzGK a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g7[id="Titles__TitleDiv-sc-5xl7gs-0"]{content:"jmvzGK,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-d8157e8dded65c3ff337.js"/><link as="script" rel="preload" href="/framework-065c3db88fdd2b546387.js"/><link as="script" rel="preload" href="/app-8b28952f62241afbe9f6.js"/><link as="script" rel="preload" href="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"/><link as="fetch" rel="preload" href="/page-data/2018/04/23/lazy-image-resizing-in-hexo-image-sizes-v2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout__Container-sc-1arw8t8-0 cnoNVM"><div class="page"><div id="content"><div id="menu" class="Menu__MenuContainer-zgpfzl-0 goernf menu"><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/"><i class="icon home"></i>travisgeis.com</a><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/contact"><i class="icon comments"></i>Contact</a></div><div id="titles" class="Titles__TitleDiv-sc-5xl7gs-0 jmvzGK"><h1>Lazy image resizing in hexo-image-sizes v2</h1><h3>23 April 2018</h3></div><i>About a <!-- -->4<!-- -->-minute read</i><p>I just released <a href="https://github.com/ottobonn/hexo-image-sizes">version 2 of
<code class="language-text">hexo-image-sizes</code></a>, which
represents a complete rewrite of the plugin. It finally supports lazy image
resizing. In this post, I will cover the high-level design ideas behind the new
version and some of the challenges in making it.</p><p>Check out my <a href="/2017/03/03/optimizing-image-sizes-in-hexo/">first post on it</a> for
more background on the functionality.</p><h2>Lazy image resizing with imsize tags</h2><p><code class="language-text">hexo-image-sizes</code> uses a special tag format for adding images to posts in Hexo.
Users add an <code class="language-text">imsize</code> tag to their post when they want to use an image with the
plugin, and in the tag they can specify various details of the image including
its size profile, its alt text, its link target, and more.</p><p>Here’s an example use of <code class="language-text">imsize</code> within a markdown post:</p><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">![Arduino Duemilanove](../uploads/2010/06/ArduinoDuemilanove.jpeg)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p>When Hexo renders a post containing an <code class="language-text">imsize</code> tag, it invokes the tag’s
registered function. The tag function has access to the user’s arguments and
some context information including the current page on which it appears, which
will be important for resolving filenames.</p><p>The <code class="language-text">imsize</code> tag affords the plugin a special ability. Because users must invoke
the tag when they want to embed a resized image in their post,
<code class="language-text">hexo-image-sizes</code> can monitor exactly which images the user has actually made
visible in his or her posts. The new version of the plugin exploits this fact to
avoid resizing images that the user never makes visible on the site.</p><p>The plugin’s operation now comprises two distinct phases during static site
generation:</p><ol><li>First, while Hexo renders each post on the site, the plugin monitors all the
<code class="language-text">imsize</code> tags the user includes in posts. Each time the user includes an
<code class="language-text">imsize</code> tag, the plugin records which image the user included and the desired
new size in a cache in memory.</li><li>After Hexo has processed all of the posts in the site, the plugin knows
which images the user wants to make visible. It generates resized versions of
each visible image.</li></ol><h2>Using Hexo’s router to avoid filesystem manipulation</h2><p>Hexo has a router module responsible for tracking which files are in use on the
site and what their contents should be. The router is a map from the path of
the file (relative to the Hexo site’s public output directory) to a stream
of the contents of the file.</p><p>The documentation for the router is missing some important details. First, it’s
very important to know that each route corresponds to a a file in the public
directory and not in the source directory. Therefore, if you add a route, you
will add a file to the public site but not alter the source directory. When I
first began work on this plugin, I assumed that the routes referenced files in
the source directory. I learned about using the router from a similar plugin,
<a href="https://github.com/hexojs/hexo-filter-responsive-images">hexo-filter-responsive-images</a>.</p><p>Using the router to add new resized images to the public output of the site
generator has several advantages. By getting each file’s contents from the route
stream managed by the router, my plugin can start to cooperate with other
asset-management plugins, like image filters and minifiers. Using the router
also allows me to remove the hacky filesystem code I was using before, where
I had to guess the output location of each file and create the directory
structure there.</p><p>Using the router also has a downside. I’m using
<a href="https://github.com/lovell/sharp">sharp</a> to resize the images, and it takes as
input either a file or a Buffer of image data, while the router provides a
stream for each file. To run the image through <code class="language-text">sharp</code>, I have to read the full
file stream into memory (in a Buffer), which adds a lot to the memory use of the
plugin. In its original form, the plugin would invoke sharp with file pointers
instead of file contents, which meant that only <code class="language-text">sharp</code> would need to see the
full contents of the image, outside of the JavaScript VM. For my site, the
increased memory use has not been an issue.</p><h2>Keeping Hexo running until all images are resized</h2><p>I discovered that running Hexo in server mode with <code class="language-text">hexo server</code> can behave
differently than running it to generate files and quit with <code class="language-text">hexo generate</code>. My
site would generate without issue when running the server, but <code class="language-text">hexo generate</code>
would only produce a few of the necessary images.</p><p>The problem was with my <code class="language-text">after_generate</code> filter function. Hexo uses the return
value of filters to determine when they are finished running, and my filter
wasn’t returning anything. When Hexo was running in server mode, it would keep
running indefinitely, long enough to allow my plugin to finish resizing
everything. In generate mode, it would exit as my plugin was just starting,
because my filter function seemed to run synchronously.</p><p>To fix the issue, I simply return a Promise from the filter function. The
Promise resolves when every image has been resized.</p><h2>Normalizing file paths throughout the application</h2><p>Hexo uses several different types of file path, and mixing them was hindering
my development of the plugin for a while. The following paths are involved in
resizing an image:</p><ul><li>The path the user put in the <code class="language-text">imsize</code> tag, which could be:<ul><li>Absolute (with a leading slash), meaning it references the Hexo source
directory</li><li>Relative (no leading slash), meaning it is relative to the current post:<ul><li>If the current post is a blog post and has an asset directory
(<code class="language-text">post_asset_folder</code>) is true  in Hexo config, then the path starts in the
asset directory</li><li>If the current post is not a blog post or <code class="language-text">post_asset_folder</code> is false,
then the path starts in the directory of the post file.</li></ul></li></ul></li></ul><p>The plugin also has access to:</p><ul><li>The absolute path to Hexo’s source directory</li><li>The absolute path to the current post’s source file</li><li>The absolute path to the current post’s asset directory, if there is one</li></ul><p>The plugin computes:</p><ul><li>A relative path from Hexo’s source directory to the image the user wants to
resize. For example, a cat picture might have path <code class="language-text">/posts/2018-cats/cat1.jpg</code></li><li>A copy of that relative path with the image renamed to have its profile name
as a prefix. For example, a thumbnail-sized version of the above cat picture
might have path <code class="language-text">/posts/2018-cats/thumbnail-cat1.jpg</code></li></ul><p>Once we know the Hexo-relative path to the input image and the output image,
we have all the information necessary to resize the image.</p><h2>Comments</h2><div id="cusdis_thread" data-host="https://travisgeis-cusdis.vercel.app" data-page-id="2018/04/23/lazy-image-resizing-in-hexo-image-sizes-v2/" data-app-id="bfc86e4c-f4e1-4135-8790-cf52804a5850" data-page-title="Lazy image resizing in hexo-image-sizes v2" data-page-url="https://travisgeis.com/2018/04/23/lazy-image-resizing-in-hexo-image-sizes-v2"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2018/04/23/lazy-image-resizing-in-hexo-image-sizes-v2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8b28952f62241afbe9f6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-933a06e9dadf888491cb.js"],"component---src-pages-page-slug-tsx":["/component---src-pages-page-slug-tsx-6a9c919aefa8eb61bff6.js"],"component---src-pages-post-slug-tsx":["/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"],"component---src-pages-project-slug-tsx":["/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-be59b2f1846831e4e707.js"]};/*]]>*/</script><script src="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js" async=""></script><script src="/app-8b28952f62241afbe9f6.js" async=""></script><script src="/framework-065c3db88fdd2b546387.js" async=""></script><script src="/webpack-runtime-d8157e8dded65c3ff337.js" async=""></script></body></html>