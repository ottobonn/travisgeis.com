<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8a856ac569de13b8b669.css" data-identity="gatsby-global-css">@font-face{font-family:Travis Print One;src:url(/static/TravisPrintOne-Regular-395b4112e8d8e4c008f2f27beb638a30.woff2) format("woff2")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#d4d0ab}.token.punctuation{color:#fefefe}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#ffa07a}.token.boolean,.token.number{color:#00e0e0}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#abe338}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#00e0e0}.token.atrule,.token.attr-value,.token.function{color:gold}.token.keyword{color:#00e0e0}.token.important,.token.regex{color:gold}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media screen and (-ms-high-contrast:active){code[class*=language-],pre[class*=language-]{background:window;color:windowText}:not(pre)>code[class*=language-],pre[class*=language-]{background:window}.token.important{background:highlight;color:window;font-weight:400}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:700}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight}.token.attr-value,.token.url{font-weight:400}}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}:root{--accent-color:#6a39ff;--code-font:"Anonymous Pro";--code-padding:2em;--code-size:75%;--font-name:"Spectral";--font-size:24px;--header-font:"Rubik",sans-serif;--link-underline:underline;--neutral-background-color:#f9f9f9;--title-box-offset:0.5rem;--title-top-margin:1rem;--link-color:var(--accent-color);--boxy-color:var(--accent-color);--wide-width:100%;--wide-margin-left:0}body{font-family:var(--font-name);font-size:var(--font-size)}h1,h2,h3,h4,h5,h6{font-family:var(--header-font);line-height:1.28571429em;margin:calc(2rem - .14286em) 0 1rem}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:-.14285714em}h1:last-child,h2:last-child,h3:last-child,h4:last-child,h5:last-child,h6:last-child{margin-bottom:0}.boxy,.gatsby-resp-image-wrapper,p>img{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color)}.gatsby-resp-image-wrapper,p>img{margin-left:var(--wide-margin-left)!important;width:var(--wide-width)}.video-container{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);height:0;margin-bottom:2rem;margin-top:2rem;padding-bottom:56.25%;position:relative;width:100%}.video-container iframe{height:100%;left:0;position:absolute;top:0;width:100%}stl-viewer{display:block;height:500px;width:100%}code{font-family:var(--code-font)!important}:not(pre)>code{background-color:#eee!important;border-radius:0!important;color:#000!important;padding:.2em!important}.gatsby-highlight{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);margin:.5em 0;margin-left:var(--wide-margin-left);overflow:auto;width:var(--wide-width)}.gatsby-highlight pre[class*=language-]{border-radius:0;margin:0;overflow:hidden;padding:var(--code-padding)}.gatsby-highlight pre[class*=language-] code{display:block;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{font-size:var(--code-size);padding-left:3em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none;left:1em!important;opacity:.5;top:var(--code-padding)}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Implementing Project Category Pages with Gatsby</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Spectral|Rubik|Anonymous+Pro" rel="stylesheet"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128"/><meta data-react-helmet="true" name="application-name" content="travisgeis.com"/><meta data-react-helmet="true" name="msapplication-TileColor" content="#FFFFFF"/><meta data-react-helmet="true" name="msapplication-TileImage" content="/favicons/mstile-144x144.png"/><meta data-react-helmet="true" name="msapplication-square70x70logo" content="/favicons/mstile-70x70.png"/><meta data-react-helmet="true" name="msapplication-square150x150logo" content="/favicons/mstile-150x150.png"/><meta data-react-helmet="true" name="msapplication-wide310x150logo" content="/favicons/mstile-310x150.png"/><meta data-react-helmet="true" name="msapplication-square310x310logo" content="/favicons/mstile-310x310.png"/><script data-react-helmet="true" type="module" src="/stl-viewer/stl-viewer.js"></script><style data-styled="" data-styled-version="5.3.0">.cnoNVM{max-width:1024px;margin-left:auto;margin-right:auto;}/*!sc*/
data-styled.g4[id="Layout__Container-sc-1arw8t8-0"]{content:"cnoNVM,"}/*!sc*/
.goernf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g5[id="Menu__MenuContainer-zgpfzl-0"]{content:"goernf,"}/*!sc*/
.hRhFsN{-webkit-text-decoration:none;text-decoration:none;font-family:var(--header-font);-webkit-flex:1;-ms-flex:1;flex:1;text-align:center;padding:0.5em;border-radius:0.25em;color:inherit;}/*!sc*/
.hRhFsN:hover{background-color:#eee;}/*!sc*/
data-styled.g6[id="Menu__MenuLink-zgpfzl-1"]{content:"hRhFsN,"}/*!sc*/
.jmvzGK{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1rem;margin-top:var(--title-top-margin);margin-bottom:2rem;}/*!sc*/
.jmvzGK a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g7[id="Titles__TitleDiv-sc-5xl7gs-0"]{content:"jmvzGK,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-d8157e8dded65c3ff337.js"/><link as="script" rel="preload" href="/framework-065c3db88fdd2b546387.js"/><link as="script" rel="preload" href="/app-8b28952f62241afbe9f6.js"/><link as="script" rel="preload" href="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"/><link as="fetch" rel="preload" href="/page-data/2021/09/06/gatsby-project-categories/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout__Container-sc-1arw8t8-0 cnoNVM"><div class="page"><div id="content"><div id="menu" class="Menu__MenuContainer-zgpfzl-0 goernf menu"><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/"><i class="icon home"></i>travisgeis.com</a><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/contact"><i class="icon comments"></i>Contact</a></div><div id="titles" class="Titles__TitleDiv-sc-5xl7gs-0 jmvzGK"><h1>Implementing Project Category Pages with Gatsby</h1><h3>6 September 2021</h3></div><i>About a <!-- -->6<!-- -->-minute read</i><p>In this post, we’ll look at how to add category tags to posts in Gatsby and generate listing pages for the posts in each category. I just switched from Hexo to Gatsby to generate this site, and unlike Hexo, Gatsby doesn’t come with the opinionated distinction between posts and pages, and it also doesn’t include a tagging or category system out of the box. For this site, I wanted to group my blog posts by the projects they’re about, in the same way a category system typically works on Hexo or Wordpress.</p><p>To configure Gatbsy, you can either install plugins or write code in one of the relevant config files. I looked for a “category” plugin, and found a deprecated one that isn’t maintained anymore, which I find suprising (doesn’t anyone else want categories? no one?). Not finding a plugin, I dove in to the config docs to add categories myself.</p><p>There are config files for different functional areas of the site, including <code class="language-text">gatsby-config.js</code> for global settings and plugins and <code class="language-text">gatsby-node.js</code> to configure how the Gatsby server runs. All the work of adding category pages goes in <code class="language-text">gatsby-node.js</code>.</p><p>Before we dive in to the code to add category pages for projects, let’s review the Gatsby build process.</p><h2>The Gatsby Site Lifecycle</h2><p>Out of the box, Gatsby can read files to create “nodes,” which represent arbitrary groups of information in its internal GraphQL API, like blog posts or author bios. I’m using some markdown plugins with Gatsby, and those create nodes of type <code class="language-text">Mdx</code> and <code class="language-text">MarkdownRemark</code> for various Markdown flavors.</p><p>When the build server starts, it sources the nodes from the sourcing plugins (like the filesystem source plugin that reads from files, or the Markdown plugins transforming files to rendered Markdown), applies transformations to the sourced nodes, makes the nodes available in the GraphQL API, and finally generates pages by querying the API. Each page exports its query, indicating what Gatbsy needs to do to generate the page.</p><p>Gatsby provides lifecycle hooks so you can write code to augment its abilities. To manage the categories of project posts for this site, I wanted to make <code class="language-text">Project</code> nodes top-level entities in the GraphQL API. Out of the box, Gatbsy (understandably) has no concept of projects, so we have to create these nodes as we see project tags on blog posts. To create the project nodes, we can add a handler to the <code class="language-text">onCreateNode</code> lifecycle hook and observe the creation of the nodes for the blog posts and the project labels associated with them.</p><h2>Markdown and Child Nodes</h2><p>My site uses plain Markdown (handled by the markdown-remark source plugin) and MDX, the React-friendly extension of plain Markdown (handled by the MDX source plugin). The MDX source plugin creates one MDX node for each Markdown file in my content directory. The Markdown files have optional metadata in their frontmatter, like the title and the project name. In the <code class="language-text">onCreateNode</code> handler, we can read the project names from every MDX node created and create corresponding project nodes.</p><p>When the Gatsby development process starts, the MDX source plugin creates each MDX node once. Nodes are immutable, so if I modify one of the Markdown files, the development server deletes the corresponding file node and MDX node (and any further children) and recreates the file and MDX nodes (any any further children).</p><h2>Tagging Nodes with Projects</h2><p>We’re almost to the code, but we have to decide how to model the project-post relationship in the GraphQL API. By the time the hooks we declare in <code class="language-text">gatbsy-node.js</code> run, the MDX plugin and other source plugins have already created their nodes. The MDX frontmatter will contain a project name if it was specified in the Markdown, as a string. Given the project name string, it’s possible to link project pages to nodes and vice versa, but Gatsby additionally provides a way for nodes to link to each other with foreign keys, making their peers available inline in GraphQL rather than requiring a separate call to perform a join.</p><p>There are two options for creating this foreign key relationship between MDX nodes and project nodes:</p><ol><li>“Modify” the existing MDX nodes to add the project link to them. The nodes are immutable, but Gatsby provides the <code class="language-text">createNodeField</code> action to associate additional fields with them in the special <code class="language-text">fields</code> subobject.</li><li>Create a new node from each MDX node, supplying the project foreign key as part of the node’s definition. The new node is the MDX node’s child, so when the MDX changes, the child will be deleted and recreated.</li></ol><p>I opted for the second option, to create a new derived node for each MDX node. Deriving new nodes from the MDX also lets us make new types of nodes, each with its own field set, rather than piling everything into extra fields attached to the MDX nodes.</p><p>While we’re making new node types, we might as well differentiate between different types of content, even if it is all Markdown underneath. I added an additional <code class="language-text">type</code> field to each post’s frontmatter to distinguish between blog posts and static pages that should not appear in the list of blog posts. Those are <code class="language-text">Post</code> and <code class="language-text">Page</code> nodes respectively.</p><p>Okay, too much talk and not enough code! Here is the snippet of <code class="language-text">gatsby-node.js</code> that creates the posts and pages:</p><div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">onCreateNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  node<span class="token punctuation">,</span>
  getNode<span class="token punctuation">,</span>
  getNodesByType<span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span> createNode<span class="token punctuation">,</span> createNodeField<span class="token punctuation">,</span> createParentChildLink<span class="token punctuation">,</span> deleteNode <span class="token punctuation">}</span><span class="token punctuation">,</span>
  createNodeId<span class="token punctuation">,</span>
  createContentDigest<span class="token punctuation">,</span>
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Field definitions omitted for brevity. `node` is the parent MDX node.</span>
  <span class="token keyword">const</span> newNode <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token function">createNodeId</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// derive a stable ID from the parent ID</span>
    parent<span class="token operator">:</span> node<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token comment">// add the parent to the child&#x27;s `parent` field</span>
    internal<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> postCategory <span class="token operator">===</span> <span class="token string">&#x27;posts&#x27;</span> <span class="token operator">?</span> <span class="token string">&#x27;Post&#x27;</span> <span class="token operator">:</span> <span class="token string">&#x27;Page&#x27;</span><span class="token punctuation">,</span> <span class="token comment">// frontmatter indicates the type</span>
      content<span class="token operator">:</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span> <span class="token comment">// I left the content on the parent instead of copying it</span>
      contentDigest<span class="token operator">:</span> <span class="token function">createContentDigest</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    project___NODE<span class="token operator">:</span> node<span class="token punctuation">.</span>frontmatter<span class="token punctuation">.</span>project<span class="token punctuation">,</span> <span class="token comment">// project foreign key</span>
    category<span class="token operator">:</span> postCategory<span class="token punctuation">,</span> <span class="token comment">// redundant with `type`, but might as well include</span>
    slug<span class="token operator">:</span> slug<span class="token punctuation">,</span> <span class="token comment">// the generated post URL</span>
    title<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>frontmatter<span class="token punctuation">.</span>title <span class="token operator">||</span> slug <span class="token operator">||</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    lede<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>frontmatter<span class="token punctuation">.</span>lede <span class="token operator">||</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    date<span class="token operator">:</span> date<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create the new Post / Page</span>
  <span class="token function">createNode</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Add the child to the parent&#x27;s `children` array</span>
  <span class="token function">createParentChildLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span> parent<span class="token operator">:</span> node<span class="token punctuation">,</span> child<span class="token operator">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>The important aspects of this design are:</p><ul><li>The child Post and Page nodes have stable IDs, generated by passing the parent ID to Gatsby’s <code class="language-text">createNodeId</code> helper (line 11).</li><li>The derived Post and Page nodes point to their MDX <code class="language-text">parent</code>, so when it is deleted the derived nodes will also be deleted (line 12).</li><li>The <code class="language-text">internal.type</code> field determines which GraphQL resolver will serve these nodes (line 14). More on that later.</li><li>The <code class="language-text">internal.content</code> (line 15) and <code class="language-text">internal.contentDigest</code> (line 16) fields are empty, leaving the content on the MDX parent. These nodes could duplicate the content, but the parent has additional field like <code class="language-text">timeToRead</code> and <code class="language-text">body</code> that are resolved dynamically in GraphQL and are not available at this stage of the build, so we will need to look at the parent node anyway.</li><li>The special <code class="language-text">project___NODE</code> (line 18) field is a foreign key to the node representing the project for this post or page. The reserved <code class="language-text">___NODE</code> suffix causes Gatsby to treat the field as a Node ID and resolve it to the Node’s content in the GraphQL API.</li></ul><h2>Rendering Posts and Pages from the GraphQL API</h2><p>The above <code class="language-text">onCreateNode</code> hook creates Post and Page nodes corresponding to MDX nodes from Markdown files. Now instead of querying the <code class="language-text">allMdx</code> and <code class="language-text">mdx</code> GraphQL resolvers to list MDX and get details, we can query two new pairs of automatically generated resolvers:</p><ul><li><code class="language-text">allPost</code> and <code class="language-text">post</code> for Post nodes</li><li><code class="language-text">allPage</code> and <code class="language-text">page</code> for Page nodes</li></ul><p>I find these dedicated resolvers convenient, but it’s also possible to filter plain MDX nodes based on their frontmatter.</p><h2>Creating Project Nodes</h2><p>Now that we have Post and Page nodes with foreign keys to project nodes, we need to create the project nodes. Creating the project nodes is straightforward with one caveat: when a post node changes, its project might change. If the changed post node was the only one for its project, the previous project will have no posts anymore and we should delete it.</p><p>I chose to use the project name, like “RC Airplane,” as its ID. Another option would be to derive a UUID from the name or slugify it. Here’s the code to create the project node, from the same <code class="language-text">onCreateNode</code> function in <code class="language-text">gatsby-node.js</code>:</p><div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">  <span class="token keyword">const</span> projectNode <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> project<span class="token punctuation">,</span>
    internal<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Project</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span>
      contentDigest<span class="token operator">:</span> <span class="token function">createContentDigest</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> project<span class="token punctuation">,</span>
    slug<span class="token operator">:</span> <span class="token function">getProjectPath</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getNode</span><span class="token punctuation">(</span>projectNode<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createNode</span><span class="token punctuation">(</span>projectNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>The project node has empty <code class="language-text">internal.content</code>, uses the project name as its ID, and has a custom <code class="language-text">slug</code> field representing its URL in slugified form, like <code class="language-text">/projects/rc-airplane</code> for the example above.</p><p>To clean up the orphaned projects with no posts, we add one additional step to the end of <code class="language-text">onCreateNode</code>:</p><div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">  <span class="token comment">// Clean up orphaned projects if node changes have left them</span>
  <span class="token keyword">const</span> projectNodes <span class="token operator">=</span> <span class="token function">getNodesByType</span><span class="token punctuation">(</span><span class="token string">&#x27;Project&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  projectNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">project</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> projectPosts <span class="token operator">=</span> project<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>posts___NODE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      projectPosts<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      projectPosts<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>newNode<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      newNode<span class="token punctuation">.</span>project___NODE <span class="token operator">!==</span> project<span class="token punctuation">.</span>id
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteNode</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>We use the Gatsby <code class="language-text">getNodesByType</code> helper to get all known projects, then look for projects whose only post is the node being created. If the node being created refers to a different project, then we know the other project(s) pointing to it are orphaned and should be deleted:</p><p><img src="/3ca3bf74698d3c400a204da13587e270/orphaned-project.svg"/></p><p>By adding and deleting projects on the fly as nodes are created, we support the Gatsby build process and also the live-updating development mode. As we edit source files, nodes retrigger the <code class="language-text">onCreateNode</code> hook and we add and remove projects as needed. As a result, the development and production builds of the site should match exactly, minimizing surprises after we deploy the site. The same code creates projects in development and production builds, but nodes aren’t deleted when building for production, so the code to delete projects only ever runs in development mode.</p><p>Here’s what our shiny new <code class="language-text">allProject</code> query looks like in Gatsby’s GraphiQL explorer:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1200px">
      <a class="gatsby-resp-image-link" href="/static/5b1e33175a1eb8bd59b0db7055878477/ec09f/allProject-query.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:48%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz22Q23KDMBBD+f/fbDrBhIvXXmkN+NKBJO00iea8npXs7vtyGdxwO+Ocu90G17u+7+d5eSdEbnt2bpimOefcLaNstrbWSinBh3ESJZkSaC/EqPO8iMi+7621Wmsn3PSUcykAr6OMkzCAlmxdD9KDqFDVnB9ma62rpZRS7820pEz9JMErFtVF4VW9QoBIkL3DOPia0c507ZlSCwIQIIoYgMOPfydE07aFgfPXNafpTS6FMIA+IAhwOucJJYwpHeONecev8k+GGWmijJFH2xzhI7zS0vEFab0/tbX6qZnmg3qvFADGdWU6eZXbZ1mU/SgqisCDyHPz+lmuz+ScQaPZEiCiGEXHoFPU6VgO2rv8A53pQs20MpiWAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="allProject query" title="allProject query" src="/static/5b1e33175a1eb8bd59b0db7055878477/c1b63/allProject-query.png" srcSet="/static/5b1e33175a1eb8bd59b0db7055878477/5a46d/allProject-query.png 300w,/static/5b1e33175a1eb8bd59b0db7055878477/0a47e/allProject-query.png 600w,/static/5b1e33175a1eb8bd59b0db7055878477/c1b63/allProject-query.png 1200w,/static/5b1e33175a1eb8bd59b0db7055878477/d61c2/allProject-query.png 1800w,/static/5b1e33175a1eb8bd59b0db7055878477/ec09f/allProject-query.png 1916w" sizes="(max-width: 1200px) 100vw, 1200px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>Each project contains an array of its posts, and each of those posts can resolve to details like the post title right in the same query! Rather than querying for all post IDs and then querying a second time to get all the post details, we have everything in one trip to the API.</p><p>Thanks for reading! If you’re looking to add category or project pages to your Gatsby site, I hope you found this long and probably confusing post helpful. Feel free to leave a comment!</p><h2>Comments</h2><div id="cusdis_thread" data-host="https://travisgeis-cusdis.vercel.app" data-page-id="2021/09/06/gatsby-project-categories//" data-app-id="bfc86e4c-f4e1-4135-8790-cf52804a5850" data-page-title="Implementing Project Category Pages with Gatsby" data-page-url="https://travisgeis.com/2021/09/06/gatsby-project-categories/"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2021/09/06/gatsby-project-categories/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8b28952f62241afbe9f6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-933a06e9dadf888491cb.js"],"component---src-pages-page-slug-tsx":["/component---src-pages-page-slug-tsx-6a9c919aefa8eb61bff6.js"],"component---src-pages-post-slug-tsx":["/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"],"component---src-pages-project-slug-tsx":["/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-be59b2f1846831e4e707.js"]};/*]]>*/</script><script src="/component---src-pages-post-slug-tsx-d0a722fe664509218382.js" async=""></script><script src="/app-8b28952f62241afbe9f6.js" async=""></script><script src="/framework-065c3db88fdd2b546387.js" async=""></script><script src="/webpack-runtime-d8157e8dded65c3ff337.js" async=""></script></body></html>