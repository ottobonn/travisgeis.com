<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.8a856ac569de13b8b669.css" data-identity="gatsby-global-css">@font-face{font-family:Travis Print One;src:url(/static/TravisPrintOne-Regular-395b4112e8d8e4c008f2f27beb638a30.woff2) format("woff2")}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#d4d0ab}.token.punctuation{color:#fefefe}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#ffa07a}.token.boolean,.token.number{color:#00e0e0}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#abe338}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#00e0e0}.token.atrule,.token.attr-value,.token.function{color:gold}.token.keyword{color:#00e0e0}.token.important,.token.regex{color:gold}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media screen and (-ms-high-contrast:active){code[class*=language-],pre[class*=language-]{background:window;color:windowText}:not(pre)>code[class*=language-],pre[class*=language-]{background:window}.token.important{background:highlight;color:window;font-weight:400}.token.atrule,.token.attr-value,.token.function,.token.keyword,.token.operator,.token.selector{font-weight:700}.token.attr-value,.token.comment,.token.doctype,.token.function,.token.keyword,.token.operator,.token.property,.token.string{color:highlight}.token.attr-value,.token.url{font-weight:400}}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}:root{--accent-color:#6a39ff;--code-font:"Anonymous Pro";--code-padding:2em;--code-size:75%;--font-name:"Spectral";--font-size:24px;--header-font:"Rubik",sans-serif;--link-underline:underline;--neutral-background-color:#f9f9f9;--title-box-offset:0.5rem;--title-top-margin:1rem;--link-color:var(--accent-color);--boxy-color:var(--accent-color);--wide-width:100%;--wide-margin-left:0}body{font-family:var(--font-name);font-size:var(--font-size)}h1,h2,h3,h4,h5,h6{font-family:var(--header-font);line-height:1.28571429em;margin:calc(2rem - .14286em) 0 1rem}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:-.14285714em}h1:last-child,h2:last-child,h3:last-child,h4:last-child,h5:last-child,h6:last-child{margin-bottom:0}.boxy,.gatsby-resp-image-wrapper,p>img{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color)}.gatsby-resp-image-wrapper,p>img{margin-left:var(--wide-margin-left)!important;width:var(--wide-width)}.video-container{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);height:0;margin-bottom:2rem;margin-top:2rem;padding-bottom:56.25%;position:relative;width:100%}.video-container iframe{height:100%;left:0;position:absolute;top:0;width:100%}stl-viewer{display:block;height:500px;width:100%}code{font-family:var(--code-font)!important}:not(pre)>code{background-color:#eee!important;border-radius:0!important;color:#000!important;padding:.2em!important}.gatsby-highlight{background-color:#fff;border:2px solid #000;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);margin:.5em 0;margin-left:var(--wide-margin-left);overflow:auto;width:var(--wide-width)}.gatsby-highlight pre[class*=language-]{border-radius:0;margin:0;overflow:hidden;padding:var(--code-padding)}.gatsby-highlight pre[class*=language-] code{display:block;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{font-size:var(--code-size);padding-left:3em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none;left:1em!important;opacity:.5;top:var(--code-padding)}</style><meta name="generator" content="Gatsby 3.15.0"/><title data-react-helmet="true">Drop CTRL</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Spectral|Rubik|Anonymous+Pro" rel="stylesheet"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png"/><link data-react-helmet="true" rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-196x196.png" sizes="196x196"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"/><link data-react-helmet="true" rel="icon" type="image/png" href="/favicons/favicon-128.png" sizes="128x128"/><meta data-react-helmet="true" name="application-name" content="travisgeis.com"/><meta data-react-helmet="true" name="msapplication-TileColor" content="#FFFFFF"/><meta data-react-helmet="true" name="msapplication-TileImage" content="/favicons/mstile-144x144.png"/><meta data-react-helmet="true" name="msapplication-square70x70logo" content="/favicons/mstile-70x70.png"/><meta data-react-helmet="true" name="msapplication-square150x150logo" content="/favicons/mstile-150x150.png"/><meta data-react-helmet="true" name="msapplication-wide310x150logo" content="/favicons/mstile-310x150.png"/><meta data-react-helmet="true" name="msapplication-square310x310logo" content="/favicons/mstile-310x310.png"/><script data-react-helmet="true" type="module" src="/stl-viewer/stl-viewer.js"></script><style data-styled="" data-styled-version="5.3.0">.cnoNVM{max-width:1024px;margin-left:auto;margin-right:auto;}/*!sc*/
data-styled.g4[id="Layout__Container-sc-1arw8t8-0"]{content:"cnoNVM,"}/*!sc*/
.goernf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g5[id="Menu__MenuContainer-zgpfzl-0"]{content:"goernf,"}/*!sc*/
.hRhFsN{-webkit-text-decoration:none;text-decoration:none;font-family:var(--header-font);-webkit-flex:1;-ms-flex:1;flex:1;text-align:center;padding:0.5em;border-radius:0.25em;color:inherit;}/*!sc*/
.hRhFsN:hover{background-color:#eee;}/*!sc*/
data-styled.g6[id="Menu__MenuLink-zgpfzl-1"]{content:"hRhFsN,"}/*!sc*/
.jmvzGK{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1rem;margin-top:var(--title-top-margin);margin-bottom:2rem;}/*!sc*/
.jmvzGK a:hover{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g7[id="Titles__TitleDiv-sc-5xl7gs-0"]{content:"jmvzGK,"}/*!sc*/
.iJfDlq{list-style:none;padding-left:0;margin-top:2em;}/*!sc*/
data-styled.g8[id="projectslug__List-hwrcz1-0"]{content:"iJfDlq,"}/*!sc*/
.cVBVKI{opacity:0.5;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-bottom:2em;}/*!sc*/
data-styled.g9[id="projectslug__Meta-hwrcz1-1"]{content:"cVBVKI,"}/*!sc*/
.dPvnkF{border:2px solid black;background-color:white;box-shadow:var(--title-box-offset) var(--title-box-offset) 0 var(--boxy-color);padding:1em;--boxy-color:gray;max-width:75%;font-family:var(--header-font);font-size:0.8em;}/*!sc*/
data-styled.g11[id="projectslug__TableOfContentsContainer-hwrcz1-3"]{content:"dPvnkF,"}/*!sc*/
.kntEac a{-webkit-text-decoration:none;text-decoration:none;color:black;}/*!sc*/
data-styled.g12[id="projectslug__PostTitle-hwrcz1-4"]{content:"kntEac,"}/*!sc*/
</style><link as="script" rel="preload" href="/webpack-runtime-d8157e8dded65c3ff337.js"/><link as="script" rel="preload" href="/framework-065c3db88fdd2b546387.js"/><link as="script" rel="preload" href="/app-8b28952f62241afbe9f6.js"/><link as="script" rel="preload" href="/a14648f9cbece78044fb371e1e04b6a8ed2832fe-a9d0acab52de6088e63d.js"/><link as="script" rel="preload" href="/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"/><link as="fetch" rel="preload" href="/page-data/projects/drop-ctrl/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout__Container-sc-1arw8t8-0 cnoNVM"><div id="menu" class="Menu__MenuContainer-zgpfzl-0 goernf menu"><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/"><i class="icon home"></i>travisgeis.com</a><a class="Menu__MenuLink-zgpfzl-1 hRhFsN item" href="/contact"><i class="icon comments"></i>Contact</a></div><div id="titles" class="Titles__TitleDiv-sc-5xl7gs-0 jmvzGK projectslug__ProjectTitles-hwrcz1-2 ivQILw"><h4>Project:</h4><h1>Drop CTRL</h1></div><div class="page"><div id="content"><div class="projectslug__TableOfContentsContainer-hwrcz1-3 dPvnkF"><p>This project has one post<!-- -->, <!-- -->about a five-minute read<!-- -->.</p><ol><li><a href="/projects/drop-ctrl/#7bec201f-7678-5881-a0a9-a231fe0b5c73">Adding Persistent Settings to Drop CTRL</a></li></ol></div><ul class="projectslug__List-hwrcz1-0 iJfDlq"><li><h2 class="projectslug__PostTitle-hwrcz1-4 kntEac"><a id="7bec201f-7678-5881-a0a9-a231fe0b5c73" href="/2020/10/05/adding-persistent-settings-to-drop-ctrl/">Adding Persistent Settings to Drop CTRL</a></h2><span class="projectslug__Meta-hwrcz1-1 cVBVKI"><span>5 October 2020</span><span>Post <!-- -->1<!-- --> of <!-- -->1<!-- --> in <!-- -->Drop CTRL</span></span><p>I recently bought a <a href="https://drop.com/buy/drop-ctrl-high-profile-mechanical-keyboard">Drop CTRL keyboard</a> and I’m quite pleased, but after a few days I noticed that every time I unplugged it, it would reset itself to the default LED animation. I did some digging into the firmware, a <a href="https://github.com/Massdrop/qmk_firmware">variant</a> of the popular <a href="https://qmk.fm/">QMK</a>, and discovered that the keyboard’s persistent storage driver is just stubbed out as an array in memory! By default, when the keyboard loses power, it forgets all the settings configured while it was on.</p><p>This article will go through the technical details of what needs to happen to get this keyboard to remember its settings correctly. It turns out that the keyboard fully supports saving its settings through a power loss, and I have ben using it with these changes for the past week.</p><h2>Just tell me the steps!</h2><p>Before we dive in, in case you just want the steps to make it work, here is how you enable persistent storage on your Drop ALT or CTRL keyboard:</p><h3>Clone and build the modified mdloader</h3><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">git clone https://github.com/ottobonn/mdloader
cd mdloader
make</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div><h3>Enable Smart EEPROM using mdloader</h3><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">cd build
./mdloader --first --smarteep</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span></span></pre></div><p>While the mdloader command is waiting for a device, enter flashing mode on your keyboard with Fn + B or the tiny button on the back. After the new firmware uploads, unplug and plug in the keyboard to restart it (it will look dead, but it’s just not restarting).</p><h3>Clone and build the modified default keymap</h3><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">git clone https://github.com/ottobonn/qmk_firmware
cd qmk_firmware
make massdrop:ctrl/default_md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div><p>If you have an ALT keyboard, you can adapt this keymap file for it.</p><h3>Load the new firmware on to the keyboard</h3><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">./mdloader --first --restart --download path/to/qmk_firmware/.build/massdrop_ctrl_default_md.hex</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div><p>Your keyboard should restart and should remember its settings from now on!</p><hr/><h2>How it all works</h2><p>With the how-to out of the way, let’s go over how the changes work to support persistent settings on the keyboard.</p><h3>Drop CTRL architecture</h3><p>Let’s start with a bit of information on how the Drop CTRL and ALT are constructed. These keyboards use an ARM processor from Micron (developed by Atmel before Micron bought them) called the <a href="https://www.microchip.com/wwwproducts/en/ATSAMD51J18A">ATSAMD51</a>. This processor is popular in the newer Arduino-compatible boards like <a href="https://www.adafruit.com/product/3857">Adafruit’s Feather M4</a>. It’s super overpowered (in a good way!) for a keyboard and more than capable of its task of updating LEDs and scanning for pressed keys.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:931px">
      <a class="gatsby-resp-image-link" href="/static/e74fb51d8f4d7078b06a631ca10dd335/c8a40/atsamd51j18a.jpg" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:100%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAMFAQIE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAbCHHHFuK0ESCv/EABoQAAIDAQEAAAAAAAAAAAAAAAECAAMRIjH/2gAIAQEAAQUCIwLYrHZcpsFNTIR4p0Z1P//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EAB4QAAEDBAMAAAAAAAAAAAAAAAABAhEQEiFRMUGR/9oACAEBAAY/AsLnakNW5WmxW+F78dQcRSaf/8QAHhAAAwACAQUAAAAAAAAAAAAAAAERMXEQIUFRYaH/2gAIAQEAAT8huuXwFkJq8U9U9CZe1gWume10xzQMqyb8lx//2gAMAwEAAgADAAAAEA8PwP/EABYRAQEBAAAAAAAAAAAAAAAAABABMf/aAAgBAwEBPxAun//EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxBhk//EABwQAQEAAwEBAQEAAAAAAAAAAAERACExQYEQcf/aAAgBAQABPxBzz2Xnovhh0VQaC7S9nPuIYmPsJj2paRxN7/vPuVoMqKPhPMkqCaZJhOQrww6Chd606fz/2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="The actual chip inside my Drop CTRL keyboard." title="The actual chip inside my Drop CTRL keyboard." src="/static/e74fb51d8f4d7078b06a631ca10dd335/c8a40/atsamd51j18a.jpg" srcSet="/static/e74fb51d8f4d7078b06a631ca10dd335/f93b5/atsamd51j18a.jpg 300w,/static/e74fb51d8f4d7078b06a631ca10dd335/b4294/atsamd51j18a.jpg 600w,/static/e74fb51d8f4d7078b06a631ca10dd335/c8a40/atsamd51j18a.jpg 931w" sizes="(max-width: 931px) 100vw, 931px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>The keyboards additionally have a USB 2.0 hub to allow one of the two onboard USB-C connectors to act as an additional port for the host computer. The keyboard processor connects to this hub as one of its downstream clients.</p><p>The keyboards are cool in other ways; check out my full review for all the other details.</p><h3>Persistent storage in microcontrollers</h3><p>Microcontrollers use random-access memory to keep track of their state while they have power, just like a full-size computer does. When they lose power, they lose the contents of RAM. However, unlike a typical computer, most microcontrollers don’t have much persistent storage, like a hard drive or flash chip. Those things have to be added to the system as additional chips.</p><p>If you’ve programmed Arduino boards, you may already know that common microcontrollers offer a tiny bit of persistent storage in the form of EEPROM, which is like RAM that doesn’t lose its contents on power loss. Most QMK-compatible keyboards seem to be based on the Arduino-staple AVR microcontrollers, and use the AVR EEPROM to store user settings in case the keyboard loses power.</p><p>However, the ATSAMD51 is a much more powerful microcontroller and its designers opted to include on-board flash for nonvolatile memory instead of the more traditional EEPROM. Flash is another form of persistent memory, but it has some quirks; the main one that separates it from EEPROM is that it can only be erased in large blocks at a time, while single bytes of EEPROM are erasable.</p><p>To overcome the limitations of flash for more traditional EEPROM applications, the SAMD51 includes “SmartEEPROM,” a programming API that uses flash to emulate EEPROM.</p><p>See page 594 of <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D5xE5x_Family_Data_Sheet_DS60001507F.pdf">the datasheet</a> for the full introduction to SmartEEPROM. Here’s the overview from that page:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1200px">
      <a class="gatsby-resp-image-link" href="/static/8e4e37adfce3042ec8b65718d07a8da6/7db30/smart-eeprom.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:53.333333333333336%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVQoz23QQdOiIBwG8L7/9+lSh6Zmaro4mSYimKVIgQIamtk4yU5a7+7O7u/AcOCBP8/E/E/f98aYMAw3m43jOLvdDkK43+9d1z0cDpZlxXFsjJm8Xi/OeRzHSZJcr9fLgFKaZZllWdPpdLvdrtfr5XI5m80Wi8VqtZrP557nvcOMsSiKbNt2XVdKWX9prR+PR9d1bds+/9F13TsshEiSBELo+34QBFrrsixvt1vTNHVdV1V1/2qapqoqrfX9fh//NTHGEEIQQhBChJDv++NKKU3T9DpgjF0ul+uXlPIT7vueEBIEAcb4eDwyxqSUeZ6P54QQUkrOOWNMCFEUBedcKTX2+n45SZKxRtu2Pc8b/w8AOAzcgeM4P2cAAG3bfsJxHEMIMcYQQjAIggAAACEcB2aMpQNKKSGEMfYpzBhDKfV9/3w+h3/AGFNK67ouB1rrqqqKolBKPZ/Pv8b2PO94PMIBAABjPLZwOp2iKEIIhWGIEBr3nPPf4TRNAQCEkPHiPM+zLCvLcmyrLEulVFEUeZ4rpYQQP4X9Am62Uq+L1OJGAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="The introduction to SmartEEPROM from the ATSAMD51 data sheet." title="The introduction to SmartEEPROM from the ATSAMD51 data sheet." src="/static/8e4e37adfce3042ec8b65718d07a8da6/c1b63/smart-eeprom.png" srcSet="/static/8e4e37adfce3042ec8b65718d07a8da6/5a46d/smart-eeprom.png 300w,/static/8e4e37adfce3042ec8b65718d07a8da6/0a47e/smart-eeprom.png 600w,/static/8e4e37adfce3042ec8b65718d07a8da6/c1b63/smart-eeprom.png 1200w,/static/8e4e37adfce3042ec8b65718d07a8da6/7db30/smart-eeprom.png 1494w" sizes="(max-width: 1200px) 100vw, 1200px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>Unfortunately, the Drop CTRL and ALT come from the factory with SmartEEPROM disabled. Fortunately, it’s easy to enable!</p><h3>Enabling SmartEEPROM on the microcontroller</h3><p>Microcontrollers are designed to support configuration options that the software running on them can’t change, for example to protect the firmware from deletion. They store this less-voltatile configuration in “fuse bits,” so named because they emulate actual hardware wires being connected or cut during manufacture. For the most part, fuse bits retain their values when the microcontroller is reprogrammed. However, unlike hardware fuses, they are editable after manufacturing.</p><p>To program the fuse bits, we need to modify the application that loads new firmware onto the keyboard. For Drop keyboards, the program is ”<a href="https://github.com/Massdrop/mdloader">mdloader</a>.” I didn’t write the changes we’re about to see, so I have to thank and give credit to Alexandre d’Alton for <a href="https://github.com/Massdrop/mdloader/pull/16">implementing it</a>.</p><p>Here’s the code that runs on the host computer to enable the SmartEEPROM fuse bits on the keyboard microcontroller:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> <span class="token function">write_user_row</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> status <span class="token operator">=</span> <span class="token function">read_half_word</span><span class="token punctuation">(</span>DSU_STATUSB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_half_word</span><span class="token punctuation">(</span>DSU_STATUSB<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* clear nvm interrupt status bits */</span>
    <span class="token class-name">uint32_t</span> cfg <span class="token operator">=</span> <span class="token function">read_word</span><span class="token punctuation">(</span>NVMCTRL_CTRLA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cfg <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0xf0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write_word</span><span class="token punctuation">(</span>NVMCTRL_CTRLA<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* set user row address */</span>
    <span class="token function">write_word</span><span class="token punctuation">(</span>NVMCTRL_ADDR<span class="token punctuation">,</span> NVMCTRL_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* erase page */</span>
    <span class="token function">write_half_word</span><span class="token punctuation">(</span>NVMCTRL_CTRLB<span class="token punctuation">,</span> <span class="token punctuation">(</span>NVMCTRL_CTRLB_CMDEX_KEY<span class="token operator">|</span>NVMCTRL_CTRLB_CMD_EP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">slp</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* erase write buffer */</span>
    <span class="token function">write_half_word</span><span class="token punctuation">(</span>NVMCTRL_CTRLB<span class="token punctuation">,</span> <span class="token punctuation">(</span>NVMCTRL_CTRLB_CMDEX_KEY<span class="token operator">|</span>NVMCTRL_CTRLB_CMD_PBC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">slp</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* write in the write buffer */</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write_word</span><span class="token punctuation">(</span>NVMCTRL_USER <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>  data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* set user row address */</span>
    <span class="token function">write_word</span><span class="token punctuation">(</span>NVMCTRL_ADDR<span class="token punctuation">,</span> NVMCTRL_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* program quad word (128bits) */</span>
    <span class="token function">write_half_word</span><span class="token punctuation">(</span>NVMCTRL_CTRLB<span class="token punctuation">,</span> <span class="token punctuation">(</span>NVMCTRL_CTRLB_CMDEX_KEY<span class="token operator">|</span>NVMCTRL_CTRLB_CMD_WQW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">slp</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>Now that we have SmartEEPROM enabled, we can implement an EEPROM driver for it!</p><h3>Adding support for SmartEEPROM to QMK</h3><p>QMK supports several different microcontrollers for keyboards, and each supported controller needs its own definitions for things like pin functions, timing, and EEPROM.</p><p>Let’s start by looking at the existing EEPROM code for the Drop keyboards:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;eeprom.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_SIZE</span> <span class="token expression"><span class="token number">32</span></span></span>

<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span>EEPROM_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">eeprom_read_byte</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uintptr_t</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">eeprom_write_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uintptr_t</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    buffer<span class="token punctuation">[</span>offset<span class="token punctuation">]</span>   <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>This code uses an in-memory array to pretend to implement EEPROM support, so it’s not suprising that the settings get lost on power down!</p><p>Thankfully, the ATSAMD51 datasheet includes an example snippet for writing to SmartEEPROM:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Declare a pointer to the SmartEEPROM start address</span>
<span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>SmartEEPROM8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> SEEPROM_ADDR<span class="token punctuation">;</span>

<span class="token comment">// Wait for the NVM to be ready</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>NVMCTRL<span class="token operator">-&gt;</span>SEESTAT<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>BUSY<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// now write to SEEPROM_ADDR like a normal array, e.g.:</span>
SEEPROM_ADDR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>Let’s build on that to implement our actual EEPROM driver:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span>EEPROM_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>smart_eeprom <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> SEEPROM_ADDR<span class="token punctuation">;</span>

bool <span class="token function">smart_eeprom_enabled</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> NVMCTRL<span class="token operator">-&gt;</span>SEESTAT<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>PSZ <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> NVMCTRL<span class="token operator">-&gt;</span>SEESTAT<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>SBLK <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool <span class="token function">wait_for_eeprom_ready</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NVMCTRL<span class="token operator">-&gt;</span>SEESTAT<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>BUSY <span class="token operator">&amp;&amp;</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>NVMCTRL<span class="token operator">-&gt;</span>SEESTAT<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>BUSY<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">eeprom_read_byte</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uintptr_t</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;=</span> EEPROM_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">smart_eeprom_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">wait_for_eeprom_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> smart_eeprom<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">eeprom_write_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uintptr_t</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;=</span> EEPROM_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">smart_eeprom_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wait_for_eeprom_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        smart_eeprom<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>This code preserves the existing in-memory behavior for ATSAM chips without SmartEEPROM enabled, and supports presistent storage in chips with SmartEEPROM enabled. See the full change <a href="https://github.com/ottobonn/qmk_firmware/blob/ea1ea011d82f731dda9e02675097cfa20c88e5ce/tmk_core/common/arm_atsam/eeprom.c">here</a>.</p><h3>Supporting EEPROM in the keymap</h3><p>Using QMK, each supported keyboard can have more than one key layout. Each layout for a keyboard gets its own <code class="language-text">keymap.c</code> file to define it. The keymap additionally defines user settings, including which values the user wants to store in EEPROM.</p><p>To support persistent storage for settings, then, we need to modify the default CTRL keymap that Drop provides. Each time the user changes a persisted setting, like LED brightness, we will save it to EEPROM immediately in case the keyboard loses power. On startup, we will read the settings from EEPROM and restore them to their in-memory variables.</p><p>Using the QMK EEPROM library has a catch: there are two provided settings areas, one for keyboard settings and one for user settings, and each gets four bytes of EEPROM. We will pack our settings into the four bytes of keyboard storage, leaving the user storage available for individual user tweaks.</p><p>We have a lot to pack into four bytes, but some of the values are small, like booleans. We can use a C union type to overlay named fields onto a 4-byte integer:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">union</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> raw<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> led_animation_id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            led_lighting_mode<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            led_animation_breathing<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            led_enabled<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            led_animation_direction<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> gcr_desired<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> led_animation_speed<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> _unused<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">kb_config_t</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>Next, we need to make this data structure the source of truth for the keyboard configuration so we can persist it to EEPROM and load it on startup. I did that by writing little helper functions for each keyboard setting key press handler. Here’s an example to advance to the next LED animation:</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">void</span> <span class="token function">led_pattern_next</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kb_config<span class="token punctuation">.</span>led_animation_id <span class="token operator">=</span> <span class="token punctuation">(</span>kb_config<span class="token punctuation">.</span>led_animation_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> led_setups_count<span class="token punctuation">;</span>
    <span class="token function">sync_settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// implemented below</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div><p>We’ve implemented functions to store values to the new structure, so the final touch is to save and load the structure from EEPROM.</p><div class="gatsby-highlight" data-language="c"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">void</span> <span class="token function">load_saved_settings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kb_config<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token function">eeconfig_read_kb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    led_animation_id <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_animation_id<span class="token punctuation">;</span>
    gcr_desired <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>gcr_desired<span class="token punctuation">;</span>
    led_lighting_mode <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_lighting_mode<span class="token punctuation">;</span>

    bool prev_led_animation_breathing <span class="token operator">=</span> led_animation_breathing<span class="token punctuation">;</span>
    led_animation_breathing <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_animation_breathing<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>led_animation_breathing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>prev_led_animation_breathing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gcr_breathe <span class="token operator">=</span> gcr_desired<span class="token punctuation">;</span>
        led_animation_breathe_cur <span class="token operator">=</span> BREATHE_MIN_STEP<span class="token punctuation">;</span>
        breathe_dir <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    led_animation_direction <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_animation_direction<span class="token punctuation">;</span>
    led_animation_speed <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_animation_speed<span class="token punctuation">;</span>

    bool led_enabled <span class="token operator">=</span> kb_config<span class="token punctuation">.</span>led_enabled<span class="token punctuation">;</span>
    <span class="token function">I2C3733_Control_Set</span><span class="token punctuation">(</span>led_enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">save_settings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Save the keyboard config to EEPROM</span>
    <span class="token function">eeconfig_update_kb</span><span class="token punctuation">(</span>kb_config<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sync_settings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">save_settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_saved_settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>You can find the full new keymap <a href="https://github.com/ottobonn/qmk_firmware/blob/ea1ea011d82f731dda9e02675097cfa20c88e5ce/keyboards/massdrop/ctrl/keymaps/default_md/keymap.c">here</a>.</p><h3>Conclusion</h3><p>I had already decided to keep my Drop CTRL before knowing whether EEPROM storage would work, so I am really glad it is possible to support after all! I am not sure why Drop hadn’t already implemented this feature, because a lot of users have been asking about it. It makes the keyboard way better to use, particularly on a laptop where the power is intermittent.</p><p>Thanks for reading! Hopefully this post helps if you’re a Drop CTRL or ALT owner who needs persistent settings storage.</p></li></ul></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/projects/drop-ctrl/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8b28952f62241afbe9f6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-933a06e9dadf888491cb.js"],"component---src-pages-page-slug-tsx":["/component---src-pages-page-slug-tsx-6a9c919aefa8eb61bff6.js"],"component---src-pages-post-slug-tsx":["/component---src-pages-post-slug-tsx-d0a722fe664509218382.js"],"component---src-pages-project-slug-tsx":["/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-be59b2f1846831e4e707.js"]};/*]]>*/</script><script src="/component---src-pages-project-slug-tsx-0058ca5e225b60a2429a.js" async=""></script><script src="/a14648f9cbece78044fb371e1e04b6a8ed2832fe-a9d0acab52de6088e63d.js" async=""></script><script src="/app-8b28952f62241afbe9f6.js" async=""></script><script src="/framework-065c3db88fdd2b546387.js" async=""></script><script src="/webpack-runtime-d8157e8dded65c3ff337.js" async=""></script></body></html>